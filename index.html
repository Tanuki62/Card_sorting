<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大六壬宗師排盤 3.5.2</title>
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --accent: #d4af37;
            --highlight: #ff4d4d;
            --heaven: #f1c40f;
            --earth: #3498db;
            --border: #333;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: "Microsoft JhengHei", "Noto Sans TC", sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container { width: 100%; max-width: 800px; }
        
        h1 { color: var(--accent); text-align: center; border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-bottom: 20px; font-size: 1.5rem; letter-spacing: 2px; }
        
        /* 控制面板 */
        .control-panel {
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border);
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            align-items: flex-start;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .input-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 0.9rem; color: #aaa; }
        input[type="datetime-local"], select {
            background: #2c2c2c; color: #fff; border: 1px solid #555;
            padding: 8px; border-radius: 4px; font-size: 1rem;
        }

        /* 月將專屬控制 */
        .yj-control { border: 1px solid #444; padding: 10px; border-radius: 6px; background: #252525; }
        .yj-toggle { font-size: 0.8rem; display: flex; align-items: center; gap: 5px; margin-bottom: 5px; cursor: pointer; }
        .yj-desc { font-size: 0.7rem; color: #777; margin-top: 3px; }

        button {
            background: var(--accent); color: #000; border: none;
            padding: 10px 30px; border-radius: 4px; font-weight: bold;
            font-size: 1.1rem; cursor: pointer; transition: 0.2s;
            margin-top: 15px; width: 100%;
        }
        button:hover { background: #fff; }

        /* 資訊列 */
        .info-bar {
            background: #2a0a0a; border: 1px solid var(--highlight);
            border-radius: 8px; padding: 15px; margin-bottom: 20px;
            display: none; justify-content: space-around; text-align: center;
        }
        .info-item .label { font-size: 0.8rem; color: #aaa; display: block; margin-bottom: 5px; }
        .info-item .val { font-size: 1.2rem; font-weight: bold; color: var(--heaven); }

        /* Grid */
        .grid-wrapper { position: relative; width: 100%; max-width: 400px; margin: 0 auto 30px; display: none; }
        .grid-board {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; aspect-ratio: 1/1;
            background: #222; padding: 5px; border-radius: 10px; border: 2px solid #444;
        }
        .cell {
            background: #333; border-radius: 5px; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid #444;
        }
        .cell.empty { visibility: hidden; }
        .cell-gen { font-size: 0.8rem; color: var(--accent); margin-bottom: 2px; }
        .cell-h { font-size: 1.4rem; font-weight: bold; color: var(--heaven); }
        .cell-e { position: absolute; bottom: 2px; right: 4px; font-size: 0.8rem; color: var(--earth); opacity: 0.8; }
        .center-label { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #555; font-size: 1.5rem; font-weight: bold; pointer-events: none; opacity: 0.3; }

        /* 四課 */
        .section-title { color: var(--accent); border-left: 4px solid var(--accent); padding-left: 10px; margin-bottom: 10px; font-size: 1.1rem; margin-top: 10px;}
        .sike-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; direction: rtl; margin-bottom: 25px; }
        .ke-box { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; padding: 10px; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .ke-rel { font-size: 0.8rem; margin-top: 5px; padding: 2px 6px; border-radius: 4px; background: #333; color: #aaa; }
        .ke-rel.zei { color: #fff; background: var(--highlight); } 
        .ke-rel.ke { color: var(--highlight); border: 1px solid var(--highlight); }

        /* 三傳 */
        .sanchuan-container { display: flex; justify-content: space-around; gap: 10px; margin-bottom: 25px; }
        .chuan-box { flex: 1; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; text-align: center; position: relative; overflow: hidden; }
        .chuan-box::before { content:''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: var(--accent); }
        .chuan-label { font-size: 0.8rem; color: #888; margin-bottom: 5px; display: block; }
        .chuan-val { font-size: 1.8rem; font-weight: bold; color: var(--heaven); }
        .chuan-gen { font-size: 0.9rem; color: var(--accent); margin-top: 5px; }

        /* 複製區 */
        .copy-area { width: 100%; box-sizing: border-box; background: #000; color: #0f0; border: 1px solid #444; padding: 15px; font-family: monospace; font-size: 0.9rem; border-radius: 5px; resize: vertical; margin-bottom: 10px; }
        .copy-btn { width: 100%; background: #2563eb; color: #fff; padding: 12px; border:none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .copy-btn:hover { background: #1d4ed8; }

    </style>
</head>
<body>

<div class="container">
    <h1>大六壬宗師排盤 V3.5 (修復版)</h1>

    <div class="control-panel">
        <div class="input-group">
            <label>占卜時間</label>
            <input type="datetime-local" id="dateInput" onchange="autoUpdateYueJiang()">
        </div>

        <div class="yj-control">
            <div class="input-group">
                <label>月將 (Yue Jiang)</label>
                <select id="yueJiangSelect" disabled></select>
            </div>
            <label class="yj-toggle">
                <input type="checkbox" id="manualYJ" onchange="toggleYueJiangMode()">
                啟用手動選擇
            </label>
            <div class="yj-desc" id="yjDesc">目前：自動匹配 (防呆模式)</div>
        </div>

        <button onclick="safeRun()">起課推演</button>
    </div>

    <div class="info-bar" id="infoBar">
        <div class="info-item"><span class="label">月將</span><span class="val" id="dispYJ">-</span></div>
        <div class="info-item"><span class="label">占時</span><span class="val" id="dispTime">-</span></div>
        <div class="info-item"><span class="label">日柱</span><span class="val" id="dispDay">-</span></div>
        <div class="info-item"><span class="label">格局</span><span class="val" id="dispMeta">-</span></div>
    </div>

    <div class="grid-wrapper" id="gridWrapper">
        <div class="grid-board" id="earthBoard"></div>
        <div class="center-label">天地盤</div>
    </div>

    <div id="sikeSection" style="display:none;">
        <div class="section-title">四課 (辛寄戌 V3.1)</div>
        <div class="sike-container" id="sikeDisplay"></div>
    </div>

    <div id="sanchuanSection" style="display:none;">
        <div class="section-title">三傳 (九宗門自動判定)</div>
        <div class="sanchuan-container" id="sanchuanDisplay"></div>
    </div>

    <div id="copySection" style="display:none;">
        <div class="section-title">傳輸給宗師</div>
        <textarea id="copyText" class="copy-area" rows="8" readonly></textarea>
        <button class="copy-btn" onclick="copyToClip()">複製並貼上</button>
    </div>
</div>

<script>
    // === 1. 核心資料 ===
    const GAN = ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"];
    const ZHI = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"];
    const WUXING = {"甲":"木","乙":"木","丙":"火","丁":"火","戊":"土","己":"土","庚":"金","辛":"金","壬":"水","癸":"水","寅":"木","卯":"木","巳":"火","午":"火","申":"金","酉":"金","亥":"水","子":"水","辰":"土","戌":"土","丑":"土","未":"土"};
    const JIGONG = {"甲":"寅", "乙":"辰", "丙":"巳", "丁":"未", "戊":"巳", "己":"未", "庚":"申", "辛":"戌", "壬":"亥", "癸":"丑"};
    const GENERALS = ["貴", "蛇", "朱", "六", "勾", "青", "空", "虎", "常", "玄", "陰", "后"];
    const GRID_MAP = ["巳", "午", "未", "申", "辰", null, null, "酉", "卯", null, null, "戌", "寅", "丑", "子", "亥"];

    // 2025年節氣表 (概略值)
    const SOLAR_TERMS_REF = [
        [1, 20, "子"], [2, 18, "亥"], [3, 20, "戌"], [4, 20, "酉"],
        [5, 21, "申"], [6, 21, "未"], [7, 22, "午"], [8, 23, "巳"],
        [9, 23, "辰"], [10, 23, "卯"], [11, 22, "寅"], [12, 21, "丑"]
    ];

    // 刑對照表 (用於三傳)
    const PUNISH_MAP = {
        "子":"卯", "卯":"子",
        "寅":"巳", "巳":"申", "申":"寅",
        "丑":"戌", "戌":"未", "未":"丑",
        "辰":"辰", "午":"午", "酉":"酉", "亥":"亥"
    };

    // 六沖對照表 (新增)
    const OPPOSITION_MAP = {
        "子":"午", "午":"子", "丑":"未", "未":"丑", "寅":"申", "申":"寅",
        "卯":"酉", "酉":"卯", "辰":"戌", "戌":"辰", "巳":"亥", "亥":"巳"
    };

    // === 2. 初始化 ===
    window.onload = function() {
        try {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            const iso = (new Date(now - offset)).toISOString().slice(0, 16);
            document.getElementById('dateInput').value = iso;

            const sel = document.getElementById('yueJiangSelect');
            sel.innerHTML = "";
            ZHI.forEach(z => {
                let op = document.createElement('option');
                op.value = z; op.text = z; sel.add(op);
            });

            autoUpdateYueJiang(); 
        } catch(e) {
            console.error("Init Error:", e);
        }
    };

    // === 3. 功能邏輯 ===

    function autoUpdateYueJiang() {
        if(document.getElementById('manualYJ').checked) return;
        
        try {
            const val = document.getElementById('dateInput').value;
            if(!val) return;
            const d = new Date(val);
            if(isNaN(d.getTime())) return;

            const m = d.getMonth() + 1;
            const day = d.getDate();
            
            let yj = "丑";
            for(let t of SOLAR_TERMS_REF) {
                if(m > t[0] || (m === t[0] && day >= t[1])) {
                    yj = t[2];
                }
            }
            if(m === 1 && day < 20) yj = "丑"; 

            document.getElementById('yueJiangSelect').value = yj;
        } catch(e) {
            console.error("YJ Error:", e);
        }
    }

    function toggleYueJiangMode() {
        const isManual = document.getElementById('manualYJ').checked;
        const sel = document.getElementById('yueJiangSelect');
        const desc = document.getElementById('yjDesc');
        sel.disabled = !isManual;
        if(isManual) {
            desc.innerText = "手動模式";
            sel.style.border = "1px solid var(--accent)";
        } else {
            desc.innerText = "自動模式";
            sel.style.border = "1px solid #555";
            autoUpdateYueJiang();
        }
    }

    function getDayGanZhi(date) {
        const baseDate = new Date(2000, 0, 1);
        const dayMs = 86400000;
        const d1 = Date.UTC(date.getFullYear(), date.getMonth(), date.getDate());
        const d2 = Date.UTC(2000, 0, 1);
        const diff = Math.floor((d1 - d2) / dayMs);
        
        let offset = (54 + diff) % 60;
        if(offset < 0) offset += 60;
        
        return { g: GAN[offset%10], z: ZHI[offset%12], txt: GAN[offset%10]+ZHI[offset%12] };
    }

    function getRel(top, bot) {
        let t = WUXING[top], b = WUXING[bot];
        if (t === b) return "比";
        const seq = ["木", "火", "土", "金", "水"];
        let ti = seq.indexOf(t), bi = seq.indexOf(b);
        if ((ti+2)%5 === bi) return "剋";
        if ((bi+2)%5 === ti) return "賊";
        if ((ti+1)%5 === bi) return "生"; 
        if ((bi+1)%5 === ti) return "生"; 
        return "無";
    }

    // 獲取驛馬 (新增)
    function GET_HORSE(dayZhi) {
        // 申子辰馬在寅, 亥卯未馬在巳, 巳酉丑馬在亥, 寅午戌馬在申
        if(["申","子","辰"].includes(dayZhi)) return "寅";
        if(["亥","卯","未"].includes(dayZhi)) return "巳";
        if(["巳","酉","丑"].includes(dayZhi)) return "亥";
        if(["寅","午","戌"].includes(dayZhi)) return "申";
        return "寅"; // default
    }

    // === 4. 執行起課 ===
    function safeRun() {
        try {
            runDivination();
        } catch(e) {
            alert("運算發生錯誤：\n" + e.message + "\n請檢查時間輸入。");
            console.error(e);
        }
    }

    function runDivination() {
        const dateVal = document.getElementById('dateInput').value;
        if(!dateVal) throw new Error("請選擇有效的日期時間");
        const date = new Date(dateVal);
        const h = date.getHours();

        // A. 基礎參數
        const day = getDayGanZhi(date);
        const yj = document.getElementById('yueJiangSelect').value;
        const tIdx = Math.floor((h + 1) / 2) % 12; 
        const zTime = ZHI[tIdx];

        // B. 晝夜 (V3.1: 卯(3)~申(8)=晝, 酉(9)~寅(2)=夜)
        const isNight = (tIdx >= 9 || tIdx <= 2);

        // C. 天地盤
        const yIdx = ZHI.indexOf(yj);
        const shift = (yIdx - tIdx + 12) % 12;
        const TP = {};
        ZHI.forEach((z, i) => TP[z] = ZHI[(i + shift) % 12]);

        // D. 神煞
        const guiMap = {"甲":0,"戊":0,"庚":0, "乙":1,"己":1, "丙":2,"丁":2, "壬":3,"癸":3, "辛":4};
        const guiVal = [["丑","未"], ["子","申"], ["亥","酉"], ["巳","卯"], ["午","寅"]]; // [晝, 夜]
        
        if(guiMap[day.g] === undefined) throw new Error("日干計算錯誤");
        
        const noble = isNight ? guiVal[guiMap[day.g]][1] : guiVal[guiMap[day.g]][0];
        
        let noblePos = "";
        for(let z in TP) if(TP[z] === noble) noblePos = z;
        const nIdx = ZHI.indexOf(noblePos);
        const isShun = (nIdx >= 11 || nIdx <= 4); 

        const gensTP = {};
        const nTpIdx = ZHI.indexOf(noble);
        GENERALS.forEach((g, i) => {
            let idx = isShun ? (nTpIdx + i)%12 : (nTpIdx - i + 12)%12;
            gensTP[ZHI[idx]] = g;
        });

        // E. 四課
        const k1e = JIGONG[day.g], k1h = TP[k1e];
        const k2e = k1h, k2h = TP[k2e];
        const k3e = day.z, k3h = TP[k3e];
        const k4e = k3h, k4h = TP[k4e];
        
        const siKe = [
            {h:k1h, e:k1e, rel:getRel(k1h, day.g)},
            {h:k2h, e:k2e, rel:getRel(k2h, k2e)},
            {h:k3h, e:k3e, rel:getRel(k3h, k3e)},
            {h:k4h, e:k4e, rel:getRel(k4h, k4e)}
        ];

        // F. 三傳 (修正核心)
        let chu = "", zhong = "", mo = "", method = "";
        let zeis = siKe.filter(k => k.rel === "賊");
        let kes = siKe.filter(k => k.rel === "剋");
        
        const isYangDay = ["甲","丙","戊","庚","壬"].includes(day.g);

        if(zeis.length > 0) {
            // 下賊上
            const yangZhis = ["子","寅","辰","午","申","戌"];
            let match = zeis.filter(k => yangZhis.includes(k.h) === isYangDay);
            
            if(match.length === 1) {
                chu = match[0].h; method = "比用(下賊上)";
            } else if(match.length > 1) {
                chu = match[0].h; method = "涉害(下賊上)"; 
            } else {
                chu = zeis[0].h; method = "重審(下賊上)";
            }
            zhong = TP[chu]; mo = TP[zhong];

        } else if(kes.length > 0) {
            // 上剋下
            const yangZhis = ["子","寅","辰","午","申","戌"];
            let match = kes.filter(k => yangZhis.includes(k.h) === isYangDay);

            if(match.length === 1) {
                chu = match[0].h; method = "比用(上剋下)";
            } else if(match.length > 1) {
                chu = match[0].h; method = "涉害(上剋下)";
            } else {
                chu = kes[0].h; method = "元首(上剋下)";
            }
            zhong = TP[chu]; mo = TP[zhong];

        } else {
            // 無賊無剋
            if (shift === 0) { 
                // 伏吟
                method = "伏吟";
                const isSelfPunish = (zhi) => PUNISH_MAP[zhi] === zhi;
                
                // 1. 初傳：陽日取干上(k1h)，陰日取支上(k3h)
                chu = isYangDay ? siKe[0].h : siKe[2].h;
                
                // 2. 判斷杜傳
                if (isSelfPunish(chu)) {
                    method += " (杜傳)";
                    // 陽日初傳用干，遇自刑，中傳改取支上(k3h)；陰日反之
                    zhong = isYangDay ? siKe[2].h : siKe[0].h;
                    
                    if (isSelfPunish(zhong)) {
                        mo = OPPOSITION_MAP[zhong]; // 取中傳之六沖
                    } else {
                        mo = PUNISH_MAP[zhong]; // 取刑
                    }
                } else {
                    // 非杜傳，常規伏吟取刑
                    zhong = PUNISH_MAP[chu];
                    // 互刑檢查
                    if (PUNISH_MAP[zhong] === chu) {
                        mo = OPPOSITION_MAP[zhong];
                    } else {
                        mo = PUNISH_MAP[zhong];
                    }
                }

            } else if (shift === 6) {
                // 返吟
                method = "返吟 (無親/井欄射)";
                let ma = GET_HORSE(day.z); 
                chu = ma;
                zhong = siKe[2].h; // 支上 (Lesson 3)
                mo = siKe[0].h;    // 干上 (Lesson 1)
            } else {
                // 遙克 / 昴星 / 別責 / 八專 (Fallback)
                method = "遙克/昴星/別責 (需進一步判斷)";
                chu = "需查"; zhong = "-"; mo = "-";
            }
        }

        // G. 渲染 UI
        document.getElementById('dispYJ').innerText = yj;
        document.getElementById('dispTime').innerText = zTime;
        document.getElementById('dispDay').innerText = day.txt;
        document.getElementById('dispMeta').innerText = method;
        document.getElementById('infoBar').style.display = 'flex';

        // Grid
        const board = document.getElementById('earthBoard');
        board.innerHTML = '';
        GRID_MAP.forEach(e => {
            const c = document.createElement('div');
            c.className = e ? 'cell' : 'cell empty';
            if(e) {
                c.innerHTML = `<div class="cell-gen">${gensTP[TP[e]]}</div><div class="cell-h">${TP[e]}</div><div class="cell-e">${e}</div>`;
            }
            board.appendChild(c);
        });
        document.getElementById('gridWrapper').style.display = 'block';

        // Sike
        const skDiv = document.getElementById('sikeDisplay');
        skDiv.innerHTML = siKe.map((k,i) => {
            let cls = k.rel==="賊"?"zei":(k.rel==="剋"?"ke":"");
            return `<div class="ke-box"><div style="font-size:0.8rem;color:#888">課${i+1}</div><div class="cell-h">${k.h}</div><div class="cell-e">${i===0?day.g:k.e}</div><div class="ke-rel ${cls}">${k.rel}</div></div>`;
        }).join('');
        document.getElementById('sikeSection').style.display = 'block';

        // Sanchuan
        const scDiv = document.getElementById('sanchuanDisplay');
        const arr = [{l:"初",v:chu},{l:"中",v:zhong},{l:"末",v:mo}];
        
        let formatG = (v) => (v && v!=="-" && v!=="需查") ? gensTP[v] : "";
        
        scDiv.innerHTML = arr.map(x => `<div class="chuan-box"><span class="chuan-label">${x.l}</span><div class="chuan-val">${x.v}</div><div class="chuan-gen">${formatG(x.v)}</div></div>`).join('');
        document.getElementById('sanchuanSection').style.display = 'block';

        // Copy Text
        const copyTxt = `
命主：(請填寫)        
問事：(請填寫)
四柱：${day.txt}日 ${zTime}時 (${isNight?'夜':'晝'})
月將：${yj} (模式:${document.getElementById('manualYJ').checked?'手動':'自動'})
天地盤：Shift=${shift} | 貴人：${noble} 臨 ${noblePos} (${isShun?'順':'逆'})

【四課】
1: ${siKe[0].h}/${day.g}(${siKe[0].rel})
2: ${siKe[1].h}/${siKe[1].e}(${siKe[1].rel})
3: ${siKe[2].h}/${siKe[2].e}(${siKe[2].rel})
4: ${siKe[3].h}/${siKe[3].e}(${siKe[3].rel})

【三傳】
初：${chu} (${formatG(chu)})
中：${zhong} (${formatG(zhong)})
末：${mo} (${formatG(mo)})
(法：${method})

宗師，請斷案。並驗證四課三傳是否正確`;

        document.getElementById('copyText').value = copyTxt;
        document.getElementById('copySection').style.display = 'block';
    }

    function copyToClip() {
        const t = document.getElementById('copyText');
        t.select();
        document.execCommand('copy');
        alert("已複製！");
    }
</script>

</body>
</html>
